<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Helvetic AI Chatbot</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

* { font-family: 'Inter', sans-serif; }

.dropdown{position:relative;display:inline-block}
.dropdown-content{display:none;position:absolute;right:0;background:#fff;min-width:160px;box-shadow:0 8px 32px rgba(0,0,0,.15);border-radius:12px;z-index:100;border:1px solid rgba(0,0,0,.1)}
.dropdown-content button{width:100%;text-align:left;padding:12px 16px;border:none;background:none;cursor:pointer;font-size:.875rem;transition:all 0.2s}
.dropdown-content button:hover{background:#f8fafc;color:#4f46e5}
.dropdown.show .dropdown-content{display:block;animation:slideDown 0.2s ease}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.line-clamp-5{display:-webkit-box;-webkit-line-clamp:5;-webkit-box-orient:vertical;overflow:hidden}

.chat-background{
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  position: relative;
}

.chat-background::before{
  content:"";
  position:absolute;
  top:0;left:0;right:0;bottom:0;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  z-index:0
}

#chatbot-messages>div{position:relative;z-index:1}

.message-bubble-bot, .message-bubble-user{
  animation: messageSlide 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

@keyframes messageSlide {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.typing-indicator {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background: rgba(255,255,255,0.9);
  border-radius: 18px;
  margin: 8px 0;
  max-width: fit-content;
  animation: messageSlide 0.3s ease;
}

.typing-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #9ca3af;
  margin: 0 2px;
  animation: typingAnimation 1.4s infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingAnimation {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-10px); opacity: 1; }
}

.gradient-header {
  background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
  position: relative;
  overflow: hidden;
}

.gradient-header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  animation: shimmer 3s linear infinite;
}

@keyframes shimmer {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.status-pulse {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 1; }
}

.question-btn {
  transition: all 0.3s ease;
  border: 1px solid rgba(79, 70, 229, 0.2);
}

.question-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 70, 229, 0.15);
  border-color: #4f46e5;
}

.input-container {
  position: relative;
  background: #ffffff; /* Blanc bien visible */
  border-radius: 24px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  border: 2px solid #4f46e5; /* Bordure violette plus visible */
  transition: all 0.3s ease;
  min-height: 56px;
  max-height: 200px; /* Limite la hauteur maximale */
}

.input-container:focus-within {
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4); /* Halo lumineux violet */
  border-color: #4f46e5;
}

.text-input-wrapper {
  display: flex;
  align-items: flex-start;
  max-height: 160px; /* Hauteur max pour la zone de texte */
  overflow-y: auto; /* Barre de d√©filement verticale */
  padding: 2px;
}

.text-input-wrapper::-webkit-scrollbar {
  width: 6px;
}

.text-input-wrapper::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.05);
  border-radius: 3px;
}

.text-input-wrapper::-webkit-scrollbar-thumb {
  background: rgba(79, 70, 229, 0.3);
  border-radius: 3px;
  transition: background 0.3s ease;
}

.text-input-wrapper::-webkit-scrollbar-thumb:hover {
  background: rgba(79, 70, 229, 0.5);
}

.voice-btn {
  transition: all 0.3s ease;
}

.voice-btn:hover {
  background: #ef4444;
  transform: scale(1.1);
}

.voice-recording {
  background: #ef4444 !important;
  animation: pulse 1s infinite;
}

.attachment-preview {
  max-width: 200px;
  max-height: 100px;
  object-fit: cover;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.sentiment-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 8px;
}

.sentiment-positive { background: #10b981; }
.sentiment-neutral { background: #6b7280; }
.sentiment-negative { background: #ef4444; }

.theme-dark {
  background: #1f2937;
  color: #f9fafb;
}

.theme-dark .chat-background::before {
  background: rgba(31, 41, 55, 0.95);
}

.theme-dark .message-bubble-bot {
  background: #374151;
  color: #f9fafb;
}

.theme-dark .input-container {
  background: #374151;
  border-color: #4b5563;
}

.satisfaction-rating {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.rating-star {
  cursor: pointer;
  font-size: 18px;
  color: #d1d5db;
  transition: all 0.2s ease;
}

.rating-star:hover,
.rating-star.active {
  color: #fbbf24;
  transform: scale(1.2);
}

.message-actions {
  opacity: 0;
  transition: opacity 0.3s ease;
  margin-top: 8px;
  display: flex;
  gap: 8px;
}

.message-container:hover .message-actions {
  opacity: 1;
}

.action-btn {
  padding: 4px 8px;
  background: rgba(0,0,0,0.05);
  border: none;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.action-btn:hover {
  background: rgba(0,0,0,0.1);
}

.quick-actions {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.quick-action {
  padding: 8px 16px;
  background: linear-gradient(135deg, #4f46e5, #7c3aed);
  color: white;
  border: none;
  border-radius: 20px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.quick-action:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
}

.conversation-stats {
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  padding: 16px;
  min-width: 200px;
  z-index: 1000;
  display: none;
}

.progress-bar {
  width: 100%;
  height: 4px;
  background: rgba(0,0,0,0.1);
  border-radius: 2px;
  overflow: hidden;
  margin-top: 8px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #4f46e5, #7c3aed);
  transition: width 0.3s ease;
}

@media (max-width: 640px) {
  .quick-actions {
    justify-content: center;
  }
  
  .dropdown-content {
    min-width: 120px;
  }
  
  #search-input::placeholder {
    font-size: 12px;
  }
}

.search-result-item {
  padding: 8px 12px;
  cursor: pointer;
  border-bottom: 1px solid #f3f4f6;
  transition: background-color 0.2s ease;
  font-size: 13px;
}

.search-result-item:last-child {
  border-bottom: none;
}

.search-result-item:hover {
  background-color: #f8fafc;
}

.search-result-question {
  font-weight: 500;
  color: #374151;
}

.search-result-preview {
  color: #6b7280;
  font-size: 12px;
  margin-top: 2px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.search-highlight {
  background-color: #fef3c7;
  font-weight: 600;
  padding: 0 2px;
  border-radius: 2px;
}

.no-results {
  padding: 16px;
  text-align: center;
  color: #6b7280;
  font-size: 13px;
}

#search-results {
  scrollbar-width: thin;
  scrollbar-color: rgba(79, 70, 229, 0.3) transparent;
}

#search-results::-webkit-scrollbar {
  width: 4px;
}

#search-results::-webkit-scrollbar-track {
  background: transparent;
}

#search-results::-webkit-scrollbar-thumb {
  background: rgba(79, 70, 229, 0.3);
  border-radius: 2px;
}
</style>
</head>
<body>
<div id="chatbot-window" class="w-full h-screen flex flex-col relative overflow-hidden">
  <!-- Header -->
  <div class="gradient-header text-white flex justify-between items-center p-4 shadow-2xl relative z-10">
    <div class="flex items-center space-x-2 sm:space-x-4">
      <div class="logo-container w-12 h-12 rounded-full flex items-center justify-center overflow-hidden bg-white/20 backdrop-blur-sm">
        <svg width="28" height="28" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <rect width="32" height="32" fill="#FF0000" rx="4"/>
          <rect x="6" y="13" width="20" height="6" fill="#FFF" rx="1"/>
          <rect x="13" y="6" width="6" height="20" fill="#FFF" rx="1"/>
        </svg>
      </div>
      <div class="min-w-0 flex-1">
        <span class="font-bold text-base sm:text-lg">Helvetic AI</span>
        <div class="flex items-center text-xs sm:text-sm opacity-90">
          <div class="status-pulse pl-3 truncate" id="status-indicator">En ligne</div>
          <div class="sentiment-indicator sentiment-positive ml-2" id="sentiment-indicator"></div>
        </div>
      </div>
    </div>
    <div class="flex items-center space-x-2 sm:space-x-3">
      <!-- Stats Button -->
      <button onclick="toggleStats()" class="relative px-3 py-1 bg-white/20 rounded text-sm">
        <i class="fas fa-chart-line mr-1"></i> Stats
        <div class="conversation-stats" id="conversation-stats">
          <h4 class="font-bold text-gray-800 mb-2">Statistiques</h4>
          <div class="text-sm text-gray-600">
            <div>Messages: <span id="message-count">0</span></div>
            <div>Satisfaction: <span id="avg-rating">N/A</span>/5</div>
            <div>Temps de r√©ponse: <span id="avg-response-time">0.8s</span></div>
          </div>
        </div>
      </button>
      
      <!-- Export Dropdown -->
      <div class="dropdown" id="exportDropdown">
        <button onclick="toggleDropdown()" class="px-3 py-1 bg-white/20 rounded text-sm">
          <i class="fas fa-download mr-1"></i> Exporter
        </button>
        <div class="dropdown-content">
          <button onclick="exportConversation('txt')">
            <i class="fas fa-file-text mr-2"></i> Exporter en TXT
          </button>
          <button onclick="exportConversation('json')">
            <i class="fas fa-file-code mr-2"></i> Exporter en JSON
          </button>
          <button onclick="exportConversation('pdf')">
            <i class="fas fa-file-pdf mr-2"></i> Exporter en PDF
          </button>
        </div>
      </div>
      
      <!-- Theme Toggle -->
      <button onclick="toggleTheme()" class="px-3 py-1 bg-white/20 rounded text-sm" id="theme-toggle">
        <i class="fas fa-moon"></i>
      </button>
      
      <!-- Language Select -->
      <select id="lang-select" class="text-gray-800 rounded-lg px-3 py-2 text-xs sm:text-sm font-medium appearance-none pr-6 sm:pr-8 focus:outline-none focus:ring-2 focus:ring-white/50 bg-white/90">
        <option value="fr">üá´üá∑ FR</option>
        <option value="en">üá¨üáß EN</option>
        <option value="de">üá©üá™ DE</option>
      </select>
      
      <button onclick="parent.closeChatbot && parent.closeChatbot()" class="w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold hover:bg-white/20 transition-colors">√ó</button>
    </div>
  </div>
  
  <!-- Messages Area -->
  <div id="chatbot-messages" class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-3 sm:space-y-4 chat-background">
    <!-- Messages will be inserted here -->
  </div>
  
  <!-- Quick Actions -->
  <div class="bg-white/80 backdrop-blur-sm px-4 py-2">
    <!-- Search Bar -->
    <div class="mb-3">
      <div class="relative">
        <input 
          type="text" 
          id="search-input" 
          placeholder="Rechercher par mot-cl√© (ex: prix, s√©curit√©, formation...)"
          class="w-full px-4 py-2 pl-10 pr-4 text-sm border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white/90"
          oninput="performSearch(this.value)"
          onkeypress="handleSearchKeyPress(event)"
        >
        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        <div id="search-results" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg z-50 mt-1 hidden max-h-60 overflow-y-auto">
          <!-- Search results will appear here -->
        </div>
      </div>
    </div>
    
    <div class="quick-actions" id="quick-actions">
      <button class="quick-action" onclick="handleQuickAction('demo')">
        <i class="fas fa-play mr-1"></i> D√©mo
      </button>
      <button class="quick-action" onclick="handleQuickAction('contact')">
        <i class="fas fa-envelope mr-1"></i> Contact
      </button>
      <button class="quick-action" onclick="handleQuickAction('pricing')">
        <i class="fas fa-tag mr-1"></i> Tarifs
      </button>
    </div>
  </div>
  
  <!-- Quick Questions -->
  <div class="border-t border-gray-200 bg-white/80 backdrop-blur-sm p-4 sm:p-6">
    <div class="text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4 flex items-center" id="questions-title">
      <i class="fas fa-question-circle w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2 text-indigo-500"></i>
      Questions rapides :
    </div>
    <div id="questions-container" class="space-y-2 sm:space-y-3"></div>
  </div>
  
  <!-- Input Area -->
  <div class="bg-white p-4 border-t border-gray-200">
    <!-- File Preview -->
    <div id="file-preview" class="mb-3 hidden">
      <div class="flex items-center p-2 bg-gray-50 rounded-lg">
        <img id="preview-image" class="attachment-preview mr-3 hidden">
        <div id="preview-text" class="flex-1 text-sm text-gray-600"></div>
        <button onclick="clearFilePreview()" class="text-red-500 hover:text-red-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    
    <div class="input-container">
      <div class="flex items-start p-2">
        <!-- Attachment Button -->
        <button onclick="document.getElementById('file-input').click()" class="p-2 text-gray-500 hover:text-indigo-600 transition-colors flex-shrink-0">
          <i class="fas fa-paperclip"></i>
        </button>
        <input type="file" id="file-input" class="hidden" accept="image/*,.pdf,.doc,.docx" onchange="handleFileUpload(event)">
        
        <!-- Text Input Wrapper with Scrollbar -->
        <div class="text-input-wrapper flex-1">
          <textarea id="user-input" 
                    placeholder="Posez votre question..." 
                    class="w-full p-2 border-none outline-none text-sm bg-transparent resize-none min-h-[40px] leading-5"
                    rows="1"
                    style="overflow-y: hidden;"
                    oninput="autoResize(this)"
                    onkeydown="handleKeyPress(event)"></textarea>
        </div>
        
        <div class="flex items-center flex-shrink-0">
          <!-- Voice Button -->
          <button onclick="toggleVoiceRecording()" class="voice-btn p-2 text-gray-500 hover:text-red-500 transition-all rounded-full mr-2" id="voice-btn">
            <i class="fas fa-microphone"></i>
          </button>
          
          <!-- Send Button -->
          <button onclick="handleUserInput()" class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all font-medium">
            <i class="fas fa-paper-plane mr-1"></i> Envoyer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Enhanced data structure
const quickQuestions = {
  fr: [
    "Qu'est-ce que l'IA en finance ?",
    "Quels sont vos services ?", 
    "Quels sont les avantages de l'EPM ?",
    "Combien co√ªte une impl√©mentation IA ?",
    "Comment garantissez-vous la s√©curit√© ?",
    "Puis-je demander une d√©mo ?",
    "Quelles sont vos r√©f√©rences clients ?",
    "Combien de temps dure l'impl√©mentation ?",
    "Proposez-vous de la formation ?",
    "Quels sont vos partenariats ?"
  ],
  en: [
    "What is AI in finance?",
    "What services do you offer?",
    "What are the benefits of EPM?", 
    "How much does AI implementation cost?",
    "How do you ensure data security?",
    "Can I request a demo?",
    "What are your client references?",
    "How long does implementation take?",
    "Do you provide training?",
    "What are your partnerships?"
  ],
  de: [
    "Was ist KI im Finanzwesen?",
    "Welche Dienstleistungen bieten Sie an?",
    "Was sind die Vorteile von EPM?",
    "Wie viel kostet eine KI-Implementierung?",
    "Wie garantieren Sie Datensicherheit?",
    "Kann ich eine Demo anfordern?",
    "Was sind Ihre Kundenreferenzen?",
    "Wie lange dauert die Implementierung?",
    "Bieten Sie Schulungen an?",
    "Was sind Ihre Partnerschaften?"
  ]
};

const translations = {
  fr: {
    welcome: `‚ú® Helvetic AI ‚Äì L'intelligence artificielle au service de la performance financi√®re ‚ú®

Helvetic AI accompagne les directions financi√®res dans leur transformation digitale.
Notre ambition : mettre la puissance de l'intelligence artificielle et de l'Enterprise Performance Management (EPM) au service des d√©cideurs, pour transformer la donn√©e en v√©ritable levier strat√©gique.

üîπ Une expertise unique : rigueur suisse + approche pragmatique et orient√©e r√©sultats.
üîπ Des solutions concr√®tes : automatisation des processus, analyse pr√©dictive, optimisation budg√©taire, pilotage de la performance.
üîπ Un engagement fort : fiabilit√© op√©rationnelle, innovation ma√Ætris√©e, conformit√© r√©glementaire.

üëâ Avec Helvetic AI, la performance financi√®re devient plus intelligente, plus rapide et plus s√ªre.`,
    online: "En ligne",
    readMore: "Lire plus",
    readLess: "Lire moins",
    typing: "En train d'√©crire...",
    rateResponse: "√âvaluez cette r√©ponse :"
  },
  en: {
    welcome: `‚ú® Helvetic AI ‚Äì Artificial Intelligence at the service of financial performance ‚ú®

Helvetic AI supports CFOs in their digital transformation, turning data into a real strategic lever through AI and EPM.

üîπ Unique expertise: Swiss precision combined with pragmatic, results-oriented methods.
üîπ Concrete solutions: automation, predictive analysis, budgeting optimization, performance management.
üîπ Strong commitment: operational reliability, controlled innovation, full compliance.

üëâ With Helvetic AI, financial performance becomes smarter, faster and safer.`,
    online: "Online",
    readMore: "Read more", 
    readLess: "Read less",
    typing: "Typing...",
    rateResponse: "Rate this response:"
  },
  de: {
    welcome: `‚ú® Helvetic AI ‚Äì K√ºnstliche Intelligenz im Dienste der Finanzperformance ‚ú®

Helvetic AI begleitet Finanzdirektionen bei der digitalen Transformation und macht Daten dank KI und EPM zu einem echten strategischen Hebel.

üîπ Einzigartige Expertise: Schweizer Pr√§zision + pragmatische, ergebnisorientierte Ans√§tze.
üîπ Konkrete L√∂sungen: Automatisierung, pr√§diktive Analysen, Budgetoptimierung, Performance-Steuerung.
üîπ Starkes Engagement: operative Zuverl√§ssigkeit, kontrollierte Innovation, volle Compliance.

üëâ Mit Helvetic AI wird die Finanzperformance intelligenter, schneller und sicherer.`,
    online: "Online",
    readMore: "Mehr lesen",
    readLess: "Weniger lesen",
    typing: "Schreibt...",
    rateResponse: "Bewerten Sie diese Antwort:"
  }
};

// Enhanced responses with more detailed information
const responses = {
  fr: {
    "Qu'est-ce que l'IA en finance ?": "L'IA en finance r√©volutionne la gestion financi√®re en automatisant les t√¢ches r√©p√©titives, en am√©liorant la pr√©cision des pr√©visions gr√¢ce √† l'analyse pr√©dictive, et en permettant une prise de d√©cision bas√©e sur des donn√©es en temps r√©el. Nos solutions incluent la d√©tection de fraudes, l'optimisation des investissements, et l'automatisation du reporting financier.",
    "Quels sont vos services ?": "Helvetic AI propose une gamme compl√®te de services : \n‚Ä¢ Automatisation des processus financiers (P2P, O2C, R2R)\n‚Ä¢ Solutions EPM (budgeting, forecasting, consolidation)\n‚Ä¢ Analyse pr√©dictive et business intelligence\n‚Ä¢ Gestion des risques et compliance\n‚Ä¢ Formation et accompagnement au changement\n‚Ä¢ Support et maintenance 24/7",
    "Quels sont les avantages de l'EPM ?": "L'EPM (Enterprise Performance Management) apporte des b√©n√©fices majeurs :\n‚Ä¢ Visibilit√© en temps r√©el sur la performance\n‚Ä¢ Planification et budgeting plus agiles\n‚Ä¢ Consolidation financi√®re automatis√©e\n‚Ä¢ R√©duction des erreurs de 90%\n‚Ä¢ Gain de temps de 60% sur le closing\n‚Ä¢ Am√©lioration de la prise de d√©cision strat√©gique",
    "Combien co√ªte une impl√©mentation IA ?": "Nos solutions sont modulaires et adapt√©es √† votre budget :\n‚Ä¢ Starter Pack : √† partir de 15 000 CHF\n‚Ä¢ Solution Standard : 50 000 - 150 000 CHF\n‚Ä¢ Solution Enterprise : sur devis\n\nInclus : licences, impl√©mentation, formation, et 6 mois de support. ROI garanti en moins de 12 mois.",
    "Comment garantissez-vous la s√©curit√© ?": "La s√©curit√© est notre priorit√© absolue :\n‚Ä¢ Conformit√© ISO 27001, GDPR, et standards bancaires suisses\n‚Ä¢ Chiffrement end-to-end AES-256\n‚Ä¢ H√©bergement en Suisse avec redondance\n‚Ä¢ Audits de s√©curit√© trimestriels\n‚Ä¢ Acc√®s par authentification multi-facteurs\n‚Ä¢ Sauvegarde et disaster recovery automatis√©s",
    "Puis-je demander une d√©mo ?": "Absolument ! Nous proposons des d√©monstrations personnalis√©es :\n‚Ä¢ D√©mo live de 30 minutes adapt√©e √† vos besoins\n‚Ä¢ Pr√©sentation de cas d'usage similaires √† votre secteur\n‚Ä¢ Q&A avec nos experts\n‚Ä¢ Proposition commerciale sur mesure\n\nContactez-nous sur demo@helvetic-ai.ch ou +41 22 123 45 67",
    "Quelles sont vos r√©f√©rences clients ?": "Nous accompagnons plus de 150+ entreprises en Suisse et en Europe :\n‚Ä¢ Banques priv√©es et corporate\n‚Ä¢ Assurances et r√©assurances\n‚Ä¢ Multinationales (pharma, luxe, technologie)\n‚Ä¢ PME en croissance\n\nTaux de satisfaction client : 98%. R√©f√©rences disponibles sur demande.",
    "Combien de temps dure l'impl√©mentation ?": "Nos d√©lais d'impl√©mentation sont optimis√©s :\n‚Ä¢ Solution Starter : 4-6 semaines\n‚Ä¢ Solution Standard : 2-4 mois\n‚Ä¢ Solution Enterprise : 6-12 mois\n\nM√©thodologie agile avec livrables par sprints de 2 semaines. Go-live progressif pour minimiser les risques.",
    "Proposez-vous de la formation ?": "Oui, la formation fait partie int√©grante de notre approche :\n‚Ä¢ Formation des utilisateurs finaux (8h)\n‚Ä¢ Formation des administrateurs (16h)\n‚Ä¢ Formation des super-users (24h)\n‚Ä¢ Supports de formation personnalis√©s\n‚Ä¢ Sessions de refresh trimestrielles\n‚Ä¢ Certification disponible",
    "Quels sont vos partenariats ?": "Helvetic AI s'appuie sur un √©cosyst√®me de partenaires de premier plan :\n‚Ä¢ Microsoft (Gold Partner Azure)\n‚Ä¢ SAP (Certified Partner)\n‚Ä¢ Oracle (Gold Partner)\n‚Ä¢ Tableau (Technology Partner)\n‚Ä¢ Int√©gration avec 200+ applications m√©tier\n\nPartenaires d'impl√©mentation en Suisse, France, et Allemagne."
  },
  en: {
    "What is AI in finance?": "AI in finance transforms financial management by automating repetitive tasks, improving forecast accuracy through predictive analytics, and enabling real-time data-driven decision making. Our solutions include fraud detection, investment optimization, and automated financial reporting.",
    "What services do you offer?": "Helvetic AI offers a comprehensive range of services:\n‚Ä¢ Financial process automation (P2P, O2C, R2R)\n‚Ä¢ EPM solutions (budgeting, forecasting, consolidation)\n‚Ä¢ Predictive analytics and business intelligence\n‚Ä¢ Risk management and compliance\n‚Ä¢ Training and change management\n‚Ä¢ 24/7 support and maintenance",
    "What are the benefits of EPM?": "EPM (Enterprise Performance Management) delivers major benefits:\n‚Ä¢ Real-time performance visibility\n‚Ä¢ More agile planning and budgeting\n‚Ä¢ Automated financial consolidation\n‚Ä¢ 90% error reduction\n‚Ä¢ 60% time savings on closing\n‚Ä¢ Improved strategic decision-making",
    "How much does AI implementation cost?": "Our solutions are modular and budget-adapted:\n‚Ä¢ Starter Pack: from CHF 15,000\n‚Ä¢ Standard Solution: CHF 50,000 - 150,000\n‚Ä¢ Enterprise Solution: custom quote\n\nIncludes: licenses, implementation, training, and 6 months support. ROI guaranteed in under 12 months.",
    "How do you ensure data security?": "Security is our absolute priority:\n‚Ä¢ ISO 27001, GDPR, and Swiss banking standards compliance\n‚Ä¢ End-to-end AES-256 encryption\n‚Ä¢ Swiss hosting with redundancy\n‚Ä¢ Quarterly security audits\n‚Ä¢ Multi-factor authentication access\n‚Ä¢ Automated backup and disaster recovery",
    "Can I request a demo?": "Absolutely! We offer personalized demonstrations:\n‚Ä¢ 30-minute live demo adapted to your needs\n‚Ä¢ Similar use cases presentation for your sector\n‚Ä¢ Q&A with our experts\n‚Ä¢ Tailored commercial proposal\n\nContact us at demo@helvetic-ai.ch or +41 22 123 45 67",
    "What are your client references?": "We support 150+ companies in Switzerland and Europe:\n‚Ä¢ Private and corporate banks\n‚Ä¢ Insurance and reinsurance\n‚Ä¢ Multinationals (pharma, luxury, technology)\n‚Ä¢ Growing SMEs\n\nClient satisfaction rate: 98%. References available upon request.",
    "How long does implementation take?": "Our implementation timelines are optimized:\n‚Ä¢ Starter Solution: 4-6 weeks\n‚Ä¢ Standard Solution: 2-4 months\n‚Ä¢ Enterprise Solution: 6-12 months\n\nAgile methodology with 2-week sprint deliverables. Progressive go-live to minimize risks.",
    "Do you provide training?": "Yes, training is an integral part of our approach:\n‚Ä¢ End-user training (8h)\n‚Ä¢ Administrator training (16h)\n‚Ä¢ Super-user training (24h)\n‚Ä¢ Personalized training materials\n‚Ä¢ Quarterly refresh sessions\n‚Ä¢ Certification available",
    "What are your partnerships?": "Helvetic AI relies on a premier partner ecosystem:\n‚Ä¢ Microsoft (Gold Partner Azure)\n‚Ä¢ SAP (Certified Partner)\n‚Ä¢ Oracle (Gold Partner)\n‚Ä¢ Tableau (Technology Partner)\n‚Ä¢ Integration with 200+ business applications\n\nImplementation partners in Switzerland, France, and Germany."
  },
  de: {
    "Was ist KI im Finanzwesen?": "KI im Finanzwesen transformiert das Finanzmanagement durch Automatisierung repetitiver Aufgaben, Verbesserung der Prognosegenauigkeit durch pr√§diktive Analysen und erm√∂glicht datenbasierte Entscheidungen in Echtzeit. Unsere L√∂sungen umfassen Betrugserkennung, Investitionsoptimierung und automatisierte Finanzberichterstattung.",
    "Welche Dienstleistungen bieten Sie an?": "Helvetic AI bietet eine umfassende Palette von Dienstleistungen:\n‚Ä¢ Automatisierung von Finanzprozessen (P2P, O2C, R2R)\n‚Ä¢ EPM-L√∂sungen (Budgetierung, Prognosen, Konsolidierung)\n‚Ä¢ Pr√§diktive Analysen und Business Intelligence\n‚Ä¢ Risikomanagement und Compliance\n‚Ä¢ Schulungen und Change Management\n‚Ä¢ 24/7 Support und Wartung",
    "Was sind die Vorteile von EPM?": "EPM (Enterprise Performance Management) bietet gro√üe Vorteile:\n‚Ä¢ Echtzeit-Performance-Transparenz\n‚Ä¢ Agilere Planung und Budgetierung\n‚Ä¢ Automatisierte Finanzkonsolidierung\n‚Ä¢ 90% Fehlerreduktion\n‚Ä¢ 60% Zeitersparnis beim Closing\n‚Ä¢ Verbesserte strategische Entscheidungsfindung",
    "Wie viel kostet eine KI-Implementierung?": "Unsere L√∂sungen sind modular und budgetangepasst:\n‚Ä¢ Starter Paket: ab CHF 15.000\n‚Ä¢ Standard L√∂sung: CHF 50.000 - 150.000\n‚Ä¢ Enterprise L√∂sung: individuelles Angebot\n\nInklusive: Lizenzen, Implementierung, Schulung und 6 Monate Support. ROI garantiert in unter 12 Monaten.",
    "Wie garantieren Sie Datensicherheit?": "Sicherheit ist unsere absolute Priorit√§t:\n‚Ä¢ ISO 27001, GDPR und Schweizer Banking-Standards Compliance\n‚Ä¢ End-to-End AES-256 Verschl√ºsselung\n‚Ä¢ Schweizer Hosting mit Redundanz\n‚Ä¢ Viertelj√§hrliche Sicherheitsaudits\n‚Ä¢ Multi-Faktor-Authentifizierung\n‚Ä¢ Automatisierte Backup und Disaster Recovery",
    "Kann ich eine Demo anfordern?": "Auf jeden Fall! Wir bieten personalisierte Demonstrationen:\n‚Ä¢ 30-min√ºtige Live-Demo angepasst an Ihre Bed√ºrfnisse\n‚Ä¢ Pr√§sentation √§hnlicher Use Cases f√ºr Ihre Branche\n‚Ä¢ Q&A mit unseren Experten\n‚Ä¢ Ma√ügeschneidertes Angebot\n\nKontaktieren Sie uns unter demo@helvetic-ai.ch oder +41 22 123 45 67",
    "Was sind Ihre Kundenreferenzen?": "Wir unterst√ºtzen 150+ Unternehmen in der Schweiz und Europa:\n‚Ä¢ Privat- und Firmenbanken\n‚Ä¢ Versicherungen und R√ºckversicherungen\n‚Ä¢ Multinationale Konzerne (Pharma, Luxus, Technologie)\n‚Ä¢ Wachsende KMU\n\nKundenzufriedenheitsrate: 98%. Referenzen auf Anfrage verf√ºgbar.",
    "Wie lange dauert die Implementierung?": "Unsere Implementierungszeitr√§ume sind optimiert:\n‚Ä¢ Starter L√∂sung: 4-6 Wochen\n‚Ä¢ Standard L√∂sung: 2-4 Monate\n‚Ä¢ Enterprise L√∂sung: 6-12 Monate\n\nAgile Methodik mit 2-Wochen-Sprint-Lieferungen. Progressiver Go-live zur Risikominimierung.",
    "Bieten Sie Schulungen an?": "Ja, Schulungen sind integraler Bestandteil unseres Ansatzes:\n‚Ä¢ Endbenutzer-Schulung (8h)\n‚Ä¢ Administrator-Schulung (16h)\n‚Ä¢ Super-User-Schulung (24h)\n‚Ä¢ Personalisierte Schulungsunterlagen\n‚Ä¢ Viertelj√§hrliche Auffrischungssitzungen\n‚Ä¢ Zertifizierung verf√ºgbar",
    "Was sind Ihre Partnerschaften?": "Helvetic AI st√ºtzt sich auf ein erstklassiges Partner-√ñkosystem:\n‚Ä¢ Microsoft (Gold Partner Azure)\n‚Ä¢ SAP (Certified Partner)\n‚Ä¢ Oracle (Gold Partner)\n‚Ä¢ Tableau (Technology Partner)\n‚Ä¢ Integration mit 200+ Gesch√§ftsanwendungen\n\nImplementierungspartner in der Schweiz, Frankreich und Deutschland."
  }
};

// Global variables
let currentLang = "fr";
let conversationHistory = [];
let isRecording = false;
let isDarkTheme = false;
let messageCount = 0;
let ratings = [];
let currentFile = null;
let searchTimeout = null;

// Keywords and synonyms for intelligent search
const searchKeywords = {
  fr: {
    "prix|co√ªt|tarif|budget|cost": ["Combien co√ªte une impl√©mentation IA ?"],
    "s√©curit√©|confidential|protection|donn√©es": ["Comment garantissez-vous la s√©curit√© ?"],
    "formation|apprentissage|training|√©cole": ["Proposez-vous de la formation ?"],
    "temps|d√©lai|dur√©e|rapidement": ["Combien de temps dure l'impl√©mentation ?"],
    "d√©mo|d√©monstration|essai|test": ["Puis-je demander une d√©mo ?"],
    "service|offre|solution|prestation": ["Quels sont vos services ?"],
    "epm|performance|management|gestion": ["Quels sont les avantages de l'EPM ?"],
    "ia|intelligence|artificielle|ai": ["Qu'est-ce que l'IA en finance ?"],
    "client|r√©f√©rence|t√©moignage|avis": ["Quelles sont vos r√©f√©rences clients ?"],
    "partenaire|partenariat|collaboration": ["Quels sont vos partenariats ?"]
  },
  en: {
    "price|cost|pricing|budget": ["How much does AI implementation cost?"],
    "security|confidential|protection|data": ["How do you ensure data security?"],
    "training|learning|education|course": ["Do you provide training?"],
    "time|duration|timeline|quickly": ["How long does implementation take?"],
    "demo|demonstration|trial|test": ["Can I request a demo?"],
    "service|offer|solution|product": ["What services do you offer?"],
    "epm|performance|management": ["What are the benefits of EPM?"],
    "ai|artificial|intelligence": ["What is AI in finance?"],
    "client|reference|testimonial|review": ["What are your client references?"],
    "partner|partnership|collaboration": ["What are your partnerships?"]
  },
  de: {
    "preis|kosten|tarif|budget": ["Wie viel kostet eine KI-Implementierung?"],
    "sicherheit|vertraulich|schutz|daten": ["Wie garantieren Sie Datensicherheit?"],
    "schulung|ausbildung|lernen|kurs": ["Bieten Sie Schulungen an?"],
    "zeit|dauer|zeitplan|schnell": ["Wie lange dauert die Implementierung?"],
    "demo|demonstration|test|probe": ["Kann ich eine Demo anfordern?"],
    "service|angebot|l√∂sung|produkt": ["Welche Dienstleistungen bieten Sie an?"],
    "epm|performance|management|leistung": ["Was sind die Vorteile von EPM?"],
    "ki|k√ºnstlich|intelligenz|ai": ["Was ist KI im Finanzwesen?"],
    "kunde|referenz|zeugnis|bewertung": ["Was sind Ihre Kundenreferenzen?"],
    "partner|partnerschaft|zusammenarbeit": ["Was sind Ihre Partnerschaften?"]
  }
};

// Intelligent search function
function performSearch(query) {
  const searchResults = document.getElementById('search-results');
  
  // Clear previous timeout
  if (searchTimeout) {
    clearTimeout(searchTimeout);
  }
  
  if (!query.trim()) {
    searchResults.classList.add('hidden');
    return;
  }
  
  // Debounce search for better performance
  searchTimeout = setTimeout(() => {
    const results = findRelevantQuestions(query.toLowerCase());
    displaySearchResults(results, query);
  }, 300);
}

function findRelevantQuestions(query) {
  const keywords = searchKeywords[currentLang];
  const allQuestions = quickQuestions[currentLang];
  const allResponses = responses[currentLang];
  const results = [];
  
  // Search in keywords first (exact matches)
  for (const [keywordPattern, matchedQuestions] of Object.entries(keywords)) {
    const regex = new RegExp(keywordPattern, 'i');
    if (regex.test(query)) {
      matchedQuestions.forEach(question => {
        if (!results.find(r => r.question === question)) {
          results.push({
            question: question,
            response: allResponses[question] || "R√©ponse disponible sur demande",
            relevance: 10, // High relevance for keyword matches
            matchType: 'keyword'
          });
        }
      });
    }
  }
  
  // Search in question text (partial matches)
  allQuestions.forEach(question => {
    const questionWords = question.toLowerCase().split(' ');
    const queryWords = query.split(' ');
    
    let matches = 0;
    queryWords.forEach(queryWord => {
      if (queryWord.length > 2) { // Ignore very short words
        questionWords.forEach(questionWord => {
          if (questionWord.includes(queryWord) || queryWord.includes(questionWord)) {
            matches++;
          }
        });
      }
    });
    
    if (matches > 0 && !results.find(r => r.question === question)) {
      results.push({
        question: question,
        response: allResponses[question] || "R√©ponse disponible sur demande",
        relevance: matches,
        matchType: 'partial'
      });
    }
  });
  
  // Search in response content (fuzzy matches)
  Object.entries(allResponses).forEach(([question, response]) => {
    if (!results.find(r => r.question === question)) {
      const responseWords = response.toLowerCase();
      let fuzzyScore = 0;
      
      query.split(' ').forEach(word => {
        if (word.length > 3 && responseWords.includes(word)) {
          fuzzyScore++;
        }
      });
      
      if (fuzzyScore > 0) {
        results.push({
          question: question,
          response: response,
          relevance: fuzzyScore * 0.5, // Lower relevance for content matches
          matchType: 'content'
        });
      }
    }
  });
  
  // Sort by relevance
  return results.sort((a, b) => b.relevance - a.relevance).slice(0, 8);
}

function displaySearchResults(results, query) {
  const searchResults = document.getElementById('search-results');
  
  if (results.length === 0) {
    searchResults.innerHTML = `
      <div class="no-results">
        <i class="fas fa-search text-gray-300 mb-2"></i>
        <div>Aucun r√©sultat pour "${query}"</div>
        <div class="text-xs mt-1">Essayez: prix, s√©curit√©, formation, d√©mo</div>
      </div>
    `;
    searchResults.classList.remove('hidden');
    return;
  }
  
  const resultsHTML = results.map(result => {
    const preview = result.response.substring(0, 100) + (result.response.length > 100 ? '...' : '');
    const highlightedQuestion = highlightText(result.question, query);
    const highlightedPreview = highlightText(preview, query);
    
    return `
      <div class="search-result-item" onclick="selectSearchResult('${result.question.replace(/'/g, "\\'")}')">
        <div class="search-result-question">${highlightedQuestion}</div>
        <div class="search-result-preview">${highlightedPreview}</div>
      </div>
    `;
  }).join('');
  
  searchResults.innerHTML = resultsHTML;
  searchResults.classList.remove('hidden');
}

function highlightText(text, query) {
  if (!query) return text;
  
  const words = query.split(' ').filter(word => word.length > 2);
  let highlightedText = text;
  
  words.forEach(word => {
    const regex = new RegExp(`(${word})`, 'gi');
    highlightedText = highlightedText.replace(regex, '<span class="search-highlight">$1</span>');
  });
  
  return highlightedText;
}

function selectSearchResult(question) {
  // Hide search results
  document.getElementById('search-results').classList.add('hidden');
  document.getElementById('search-input').value = '';
  
  // Send the selected question
  addMessage(question, "user");
  showTypingIndicator();
  
  setTimeout(() => {
    hideTypingIndicator();
    const response = responses[currentLang][question] || getAIResponse(question) || "Merci pour cette question. Je vais vous mettre en contact avec un expert.";
    addMessage(response, "bot");
  }, 1000);
}

function handleSearchKeyPress(event) {
  const searchResults = document.getElementById('search-results');
  
  if (event.key === 'Enter') {
    const firstResult = searchResults.querySelector('.search-result-item');
    if (firstResult) {
      firstResult.click();
    }
  } else if (event.key === 'Escape') {
    searchResults.classList.add('hidden');
    document.getElementById('search-input').value = '';
  }
}

// Sentiment analysis simulation
function analyzeSentiment(text) {
  const positiveWords = ['excellent', 'parfait', 'super', 'g√©nial', 'fantastique', 'merci'];
  const negativeWords = ['probl√®me', 'erreur', 'mauvais', 'd√©faut', 'bug', 'lent'];
  
  const words = text.toLowerCase().split(' ');
  let score = 0;
  
  words.forEach(word => {
    if (positiveWords.includes(word)) score += 1;
    if (negativeWords.includes(word)) score -= 1;
  });
  
  if (score > 0) return 'positive';
  if (score < 0) return 'negative';
  return 'neutral';
}

function updateSentimentIndicator(sentiment) {
  const indicator = document.getElementById('sentiment-indicator');
  indicator.className = `sentiment-indicator sentiment-${sentiment}`;
}

// Enhanced message addition with actions and ratings
function addMessage(text, sender = "bot", isWelcome = false, showActions = true) {
  const container = document.createElement("div");
  container.className = `message-container ${sender === "user" ? "text-right" : "text-left"}`;
  
  const bubble = document.createElement("div");
  bubble.className = sender === "user" ? 
    "inline-block px-4 py-3 rounded-2xl max-w-xs lg:max-w-md text-sm font-medium message-bubble-user bg-gradient-to-r from-indigo-600 to-purple-600 text-white" :
    "inline-block px-4 py-3 rounded-2xl max-w-xs lg:max-w-md text-sm font-medium message-bubble-bot bg-white/90 backdrop-blur-sm whitespace-pre-line";

  if (isWelcome) {
    bubble.innerHTML = `
      <div id="welcome-preview" class="line-clamp-5">${text}</div>
      <button id="toggleWelcome" class="mt-2 text-indigo-600 text-xs underline">${translations[currentLang].readMore}</button>
    `;
    setTimeout(() => {
      const toggleBtn = document.getElementById("toggleWelcome");
      const preview = document.getElementById("welcome-preview");
      if (toggleBtn && preview) {
        toggleBtn.addEventListener("click", () => {
          if (toggleBtn.textContent === translations[currentLang].readMore) {
            preview.classList.remove("line-clamp-5");
            toggleBtn.textContent = translations[currentLang].readLess;
          } else {
            preview.classList.add("line-clamp-5");
            toggleBtn.textContent = translations[currentLang].readMore;
          }
        });
      }
    }, 50);
  } else {
    bubble.innerHTML = text;
  }

  container.appendChild(bubble);

  // Add message actions for bot messages
  if (sender === "bot" && showActions && !isWelcome) {
    const actions = document.createElement("div");
    actions.className = "message-actions";
    actions.innerHTML = `
      <button class="action-btn" onclick="copyMessage('${text.replace(/'/g, "\\'")}')">
        <i class="fas fa-copy mr-1"></i> Copier
      </button>
      <button class="action-btn" onclick="shareMessage('${text.replace(/'/g, "\\'")}')">
        <i class="fas fa-share mr-1"></i> Partager
      </button>
    `;
    container.appendChild(actions);

    // Add rating system
    const ratingDiv = document.createElement("div");
    ratingDiv.innerHTML = `
      <div class="text-xs text-gray-500 mt-2">${translations[currentLang].rateResponse}</div>
      <div class="satisfaction-rating">
        ${[1,2,3,4,5].map(i => `<span class="rating-star" onclick="rateMessage(${i}, this)">‚≠ê</span>`).join('')}
      </div>
    `;
    container.appendChild(ratingDiv);
  }

  document.getElementById("chatbot-messages").appendChild(container);
  document.getElementById("chatbot-messages").scrollTop = document.getElementById("chatbot-messages").scrollHeight;

  // Update conversation history
  conversationHistory.push({
    sender: sender,
    text: text,
    time: new Date().toISOString(),
    sentiment: sender === "user" ? analyzeSentiment(text) : "neutral"
  });

  messageCount++;
  updateStats();

  // Update sentiment for user messages
  if (sender === "user") {
    updateSentimentIndicator(analyzeSentiment(text));
  }
}

function showTypingIndicator() {
  const indicator = document.createElement("div");
  indicator.id = "typing-indicator";
  indicator.className = "text-left";
  indicator.innerHTML = `
    <div class="typing-indicator">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <span class="ml-2 text-xs text-gray-500">${translations[currentLang].typing}</span>
    </div>
  `;
  document.getElementById("chatbot-messages").appendChild(indicator);
  document.getElementById("chatbot-messages").scrollTop = document.getElementById("chatbot-messages").scrollHeight;
}

function hideTypingIndicator() {
  const indicator = document.getElementById("typing-indicator");
  if (indicator) {
    indicator.remove();
  }
}

// Enhanced user input handling
function handleUserInput() {
  const input = document.getElementById("user-input");
  const text = input.value.trim();
  
  if (text) {
    addMessage(text, "user");
    input.value = "";
    autoResize(input); // Reset textarea size
    
    showTypingIndicator();
    
    setTimeout(() => {
      hideTypingIndicator();
      const response = responses[currentLang][text] || 
        getAIResponse(text) || 
        "D√©sol√©, je n'ai pas encore de r√©ponse pr√©cise pour cette question. Puis-je vous proposer une d√©monstration personnalis√©e pour mieux comprendre vos besoins ?";
      addMessage(response, "bot");
    }, 1200 + Math.random() * 800); // Variable response time
  }
}

// Auto-resize textarea function
function autoResize(textarea) {
  // Reset height to auto to get the correct scrollHeight
  textarea.style.height = 'auto';
  
  // Calculate the new height based on content
  const newHeight = Math.min(textarea.scrollHeight, 120); // Max 120px (about 6 lines)
  
  // Set the new height
  textarea.style.height = newHeight + 'px';
  
  // Show scrollbar if content exceeds max height
  if (textarea.scrollHeight > 120) {
    textarea.style.overflowY = 'auto';
  } else {
    textarea.style.overflowY = 'hidden';
  }
}

// Updated key press handler for textarea
function handleKeyPress(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault(); // Prevent new line
    handleUserInput();
  }
  // Allow Shift+Enter for new lines
}

// AI-like response generation for unknown questions
function getAIResponse(question) {
  const lowerQuestion = question.toLowerCase();
  
  if (lowerQuestion.includes('prix') || lowerQuestion.includes('co√ªt') || lowerQuestion.includes('tarif')) {
    return "Nos tarifs d√©pendent de vos besoins sp√©cifiques. Nous proposons des solutions √† partir de 15 000 CHF. Souhaitez-vous que je vous mette en contact avec un de nos consultants pour une estimation personnalis√©e ?";
  }
  
  if (lowerQuestion.includes('s√©curit√©') || lowerQuestion.includes('confidential')) {
    return "La s√©curit√© des donn√©es est au c≈ìur de notre approche. Nous respectons les standards suisses et europ√©ens les plus stricts (ISO 27001, GDPR). Toutes vos donn√©es restent en Suisse avec un chiffrement de niveau bancaire.";
  }
  
  if (lowerQuestion.includes('temps') || lowerQuestion.includes('dur√©e') || lowerQuestion.includes('d√©lai')) {
    return "Les d√©lais d'impl√©mentation varient selon la complexit√© : de 4 semaines pour nos solutions Starter √† 6 mois pour les projets Enterprise. Notre approche agile garantit des r√©sultats rapides et mesurables.";
  }
  
  if (lowerQuestion.includes('formation') || lowerQuestion.includes('apprentissage')) {
    return "Nous incluons syst√©matiquement la formation dans nos projets : formation des utilisateurs, administrateurs, et super-users, avec des supports personnalis√©s et des sessions de refresh r√©guli√®res.";
  }
  
  return null;
}

// Quick actions
function handleQuickAction(action) {
  const actions = {
    fr: {
      demo: "J'aimerais voir une d√©monstration de vos solutions IA pour la finance.",
      contact: "Comment puis-je contacter votre √©quipe commerciale ?",
      pricing: "Pouvez-vous me donner plus d'informations sur vos tarifs ?"
    },
    en: {
      demo: "I would like to see a demonstration of your AI solutions for finance.",
      contact: "How can I contact your sales team?",
      pricing: "Can you give me more information about your pricing?"
    },
    de: {
      demo: "Ich m√∂chte eine Demonstration Ihrer KI-L√∂sungen f√ºr das Finanzwesen sehen.",
      contact: "Wie kann ich Ihr Vertriebsteam kontaktieren?",
      pricing: "K√∂nnen Sie mir mehr Informationen zu Ihren Preisen geben?"
    }
  };
  
  const message = actions[currentLang][action];
  if (message) {
    addMessage(message, "user");
    setTimeout(() => {
      const response = responses[currentLang][Object.values(quickQuestions[currentLang])[Object.keys(actions[currentLang]).indexOf(action)]] ||
        "Merci pour votre int√©r√™t ! Je vais vous mettre en contact avec un de nos experts.";
      addMessage(response, "bot");
    }, 800);
  }
}

// File upload handling
function handleFileUpload(event) {
  const file = event.target.files[0];
  if (file) {
    currentFile = file;
    const preview = document.getElementById("file-preview");
    const previewText = document.getElementById("preview-text");
    const previewImage = document.getElementById("preview-image");
    
    preview.classList.remove("hidden");
    
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImage.src = e.target.result;
        previewImage.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
      previewText.textContent = `Image: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
    } else {
      previewImage.classList.add("hidden");
      previewText.textContent = `Document: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
    }
  }
}

function clearFilePreview() {
  document.getElementById("file-preview").classList.add("hidden");
  document.getElementById("file-input").value = "";
  currentFile = null;
}

// Voice recording
function toggleVoiceRecording() {
  const btn = document.getElementById("voice-btn");
  
  if (!isRecording) {
    startRecording();
    btn.classList.add("voice-recording");
    btn.innerHTML = '<i class="fas fa-stop"></i>';
    isRecording = true;
  } else {
    stopRecording();
    btn.classList.remove("voice-recording");
    btn.innerHTML = '<i class="fas fa-microphone"></i>';
    isRecording = false;
  }
}

function startRecording() {
  // Simulate voice recording
  console.log("Voice recording started...");
}

function stopRecording() {
  // Simulate voice recording stop
  console.log("Voice recording stopped...");
  // Here you would typically process the audio and convert to text
  const simulatedText = "Message vocal converti en texte";
  document.getElementById("user-input").value = simulatedText;
}

// Message actions
function copyMessage(text) {
  navigator.clipboard.writeText(text).then(() => {
    showNotification("Message copi√© !");
  });
}

function shareMessage(text) {
  if (navigator.share) {
    navigator.share({
      title: 'Helvetic AI',
      text: text
    });
  } else {
    copyMessage(text);
    showNotification("Message copi√© pour partage !");
  }
}

function rateMessage(rating, element) {
  // Update visual feedback
  const stars = element.parentNode.querySelectorAll('.rating-star');
  stars.forEach((star, index) => {
    if (index < rating) {
      star.classList.add('active');
    } else {
      star.classList.remove('active');
    }
  });
  
  ratings.push(rating);
  updateStats();
  showNotification("Merci pour votre √©valuation !");
}

// Quick questions update
function updateQuickQuestions() {
  const container = document.getElementById("questions-container");
  container.innerHTML = "";
  
  // Show random 4 questions
  const questions = [...quickQuestions[currentLang]].sort(() => Math.random() - 0.5).slice(0, 4);
  
  questions.forEach(question => {
    const btn = document.createElement("button");
    btn.className = "question-btn w-full text-left p-3 rounded-xl text-sm font-medium text-gray-700 bg-white/70 hover:bg-white transition-all";
    btn.textContent = question;
    btn.onclick = () => {
      addMessage(question, "user");
      showTypingIndicator();
      setTimeout(() => {
        hideTypingIndicator();
        const reply = responses[currentLang][question] || getAIResponse(question) || "Merci pour cette question int√©ressante. Laissez-moi vous mettre en contact avec un expert.";
        addMessage(reply, "bot");
      }, 1000);
    };
    container.appendChild(btn);
  });
}

// Theme toggle
function toggleTheme() {
  isDarkTheme = !isDarkTheme;
  const body = document.body;
  const themeBtn = document.getElementById("theme-toggle");
  
  if (isDarkTheme) {
    body.classList.add("theme-dark");
    themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
  } else {
    body.classList.remove("theme-dark");
    themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
  }
}

// Statistics
function updateStats() {
  document.getElementById("message-count").textContent = messageCount;
  
  if (ratings.length > 0) {
    const avgRating = ratings.reduce((a, b) => a + b, 0) / ratings.length;
    document.getElementById("avg-rating").textContent = avgRating.toFixed(1);
  }
}

function toggleStats() {
  const stats = document.getElementById("conversation-stats");
  stats.style.display = stats.style.display === "block" ? "none" : "block";
}

// Export functions
function exportConversation(format = "txt") {
  if (conversationHistory.length === 0) {
    showNotification("Aucune conversation √† exporter.");
    return;
  }

  let content, blob, filename;
  
  if (format === "json") {
    content = JSON.stringify({
      conversation: conversationHistory,
      stats: {
        messageCount: messageCount,
        averageRating: ratings.length > 0 ? ratings.reduce((a, b) => a + b, 0) / ratings.length : null,
        language: currentLang
      },
      exportDate: new Date().toISOString()
    }, null, 2);
    blob = new Blob([content], { type: "application/json" });
    filename = `helvetic-ai-conversation-${new Date().toISOString().split('T')[0]}.json`;
  } else if (format === "pdf") {
    // For PDF export, we'll create a formatted text version
    content = `Helvetic AI - Conversation Export
Date: ${new Date().toLocaleString()}
Language: ${currentLang.toUpperCase()}
Messages: ${messageCount}
${ratings.length > 0 ? `Average Rating: ${(ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1)}/5` : ''}

${'='.repeat(50)}

${conversationHistory.map(msg => 
  `[${new Date(msg.time).toLocaleTimeString()}] ${msg.sender.toUpperCase()}: ${msg.text}`
).join('\n\n')}`;
    blob = new Blob([content], { type: "text/plain" });
    filename = `helvetic-ai-conversation-${new Date().toISOString().split('T')[0]}.pdf`;
  } else {
    content = conversationHistory.map(msg => 
      `[${new Date(msg.time).toLocaleTimeString()}] ${msg.sender.toUpperCase()}: ${msg.text}`
    ).join('\n\n');
    blob = new Blob([content], { type: "text/plain" });
    filename = `helvetic-ai-conversation-${new Date().toISOString().split('T')[0]}.txt`;
  }

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
  
  document.getElementById("exportDropdown").classList.remove("show");
  showNotification(`Conversation export√©e en ${format.toUpperCase()} !`);
}

// Utility functions
function showNotification(message) {
  const notification = document.createElement("div");
  notification.className = "fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all";
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = "0";
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}

function toggleDropdown() {
  document.getElementById("exportDropdown").classList.toggle("show");
}

// Language change handler
document.addEventListener("DOMContentLoaded", () => {
  addMessage(translations[currentLang].welcome, "bot", true);
  updateQuickQuestions();
});

// Event listeners
document.getElementById("lang-select").addEventListener("change", (e) => {
  currentLang = e.target.value;
  document.getElementById("status-indicator").textContent = translations[currentLang].online;
  
  // Clear and restart conversation
  document.getElementById("chatbot-messages").innerHTML = "";
  conversationHistory = [];
  messageCount = 0;
  ratings = [];
  
  // Clear search
  document.getElementById("search-input").value = "";
  document.getElementById("search-results").classList.add("hidden");
  
  addMessage(translations[currentLang].welcome, "bot", true);
  updateQuickQuestions();
  updateSearchPlaceholder();
  updateStats();
});

// Close dropdowns when clicking outside
window.addEventListener("click", (e) => {
  if (!e.target.closest("#exportDropdown")) {
    document.getElementById("exportDropdown").classList.remove("show");
  }
  if (!e.target.closest("#conversation-stats") && !e.target.matches('[onclick="toggleStats()"]')) {
    document.getElementById("conversation-stats").style.display = "none";
  }
  
  // Close search results when clicking outside
  if (!e.target.closest("#search-input") && !e.target.closest("#search-results")) {
    const searchResults = document.getElementById("search-results");
    if (searchResults) {
      searchResults.classList.add("hidden");
    }
  }
});

// Update search placeholder text when language changes
function updateSearchPlaceholder() {
  const searchInput = document.getElementById("search-input");
  const placeholders = {
    fr: "Rechercher par mot-cl√© (ex: prix, s√©curit√©, formation...)",
    en: "Search by keyword (ex: price, security, training...)",
    de: "Nach Stichwort suchen (z.B: Preis, Sicherheit, Schulung...)"
  };
  
  if (searchInput) {
    searchInput.placeholder = placeholders[currentLang];
  }
}
</script>
</body>
</html>
