<!-- Structure correcte pour votre fichier chatbot -->

<!-- Fen√™tre du chatbot -->
<div id="chatbot-window" class="w-full h-screen glass-effect flex flex-col">
  <!-- Votre HTML existant du chatbot -->
</div>

<!-- IMPORTATION FAQ - AVANT le script principal -->
<script src="faq.js"></script>

<!-- SCRIPT PRINCIPAL du chatbot -->
<script>
/* === R√©ponses multilingues de base === */
const responses = {
  fr: { 
    welcome:"Bonjour üëã Je suis le chatbot Helvitic AI sp√©cialis√© en IA pour la performance financi√®re. Posez-moi vos questions sur l'EPM, l'automatisation ou nos solutions.",
    greeting:"Bonjour! Comment puis-je vous aider avec l'IA en finance ?",
    services:"Nous offrons des solutions IA pour l'EPM : pr√©visions automatis√©es, budgeting intelligent, d√©tection d'anomalies, et optimisation des processus financiers.",
    contact:"Vous pouvez nous contacter via email : helviticaich@gmail.com ou par t√©l√©phone +41 22 123 45 67.",
    goodbye:"Merci pour votre int√©r√™t ! N'h√©sitez pas √† nous recontacter pour vos projets IA & Finance üëã",
    unknown:"Je n'ai pas trouv√© d'information sur ce sujet. Pouvez-vous reformuler ou poser une question sur l'IA en finance, l'EPM, ou nos solutions ?" 
  },
  en: {
    welcome:"Hello üëã I'm the Helvitic AI chatbot specialized in AI for financial performance. Ask me about EPM, automation, or our solutions.",
    greeting:"Hello! How can I help you with AI in finance?",
    services:"We provide AI solutions for EPM: automated forecasting, intelligent budgeting, anomaly detection, and financial process optimization.",
    contact:"You can reach us via email: helviticaich@gmail.com or phone +41 22 123 45 67.",
    goodbye:"Thank you for your interest! Feel free to contact us again for your AI & Finance projects üëã",
    unknown:"I couldn't find information on this topic. Could you rephrase or ask about AI in finance, EPM, or our solutions?"
  },
  de: {
    welcome:"Hallo üëã Ich bin der Helvitic AI Chatbot f√ºr KI in der Finanzperformance. Fragen Sie mich zu EPM, Automatisierung oder unseren L√∂sungen.",
    greeting:"Hallo! Wie kann ich Ihnen mit KI im Finanzwesen helfen?",
    services:"Wir bieten KI-L√∂sungen f√ºr EPM: automatisierte Prognosen, intelligente Budgetierung, Anomalieerkennung und Optimierung von Finanzprozessen.",
    contact:"Sie erreichen uns per E-Mail: helviticaich@gmail.com oder Telefon +41 22 123 45 67.",
    goodbye:"Vielen Dank f√ºr Ihr Interesse! Kontaktieren Sie uns gerne f√ºr Ihre KI & Finance Projekte üëã",
    unknown:"Ich konnte keine Information zu diesem Thema finden. K√∂nnen Sie umformulieren oder zu KI im Finanzwesen, EPM oder unseren L√∂sungen fragen?"
  }
};

/* === FAQ multilingue pour boutons rapides === */
const faqData = {
  fr: {
    title: "‚ùì Questions fr√©quentes",
    questions: [
      "Quels services proposez-vous ?",
      "Comment vous contacter ?",
      "Pouvez-vous m'aider avec la finance ?"
    ]
  },
  en: {
    title: "‚ùì Frequently Asked Questions",
    questions: [
      "What services do you provide?",
      "How can I contact you?",
      "Can you help me with finance?"
    ]
  },
  de: {
    title: "‚ùì H√§ufig gestellte Fragen",
    questions: [
      "Welche Dienstleistungen bieten Sie an?",
      "Wie kann ich Sie kontaktieren?",
      "K√∂nnen Sie mir bei Finanzen helfen?"
    ]
  }
};

let currentLang = "fr";

// S√©lecteurs
const botForm = document.getElementById("bot-form");
const botInput = document.getElementById("bot-input");
const botMessages = document.getElementById("chatbot-messages");
const langSelect = document.getElementById("lang-select");
const faqQuick = document.getElementById("faq-quick");
const faqTitle = document.getElementById("faq-title");

// Fonction affichage message
function addMessage(sender, text) {
  const div = document.createElement("div");
  div.className = sender === "bot" 
    ? "message-bot px-3 py-2 rounded-lg bg-gray-100 mb-2" 
    : "message-user px-3 py-2 rounded-lg text-right bg-blue-500 text-white mb-2";
  
  const formattedText = text.replace(/\n/g, '<br>');
  div.innerHTML = `<strong>${sender==="bot"?"Helvitic AI":"Vous"}:</strong> ${formattedText}`;
  
  botMessages.appendChild(div);
  botMessages.scrollTop = botMessages.scrollHeight;
}

// Fonction de recherche intelligente
function searchFAQ(query, lang = 'fr') {
  if (typeof faq === 'undefined') return null;
  
  const faqLang = faq[lang] || faq.fr;
  const normalizedQuery = query.toLowerCase()
    .replace(/[√†√°√¢√£√§√•]/g, 'a')
    .replace(/[√®√©√™√´]/g, 'e')
    .replace(/[√¨√≠√Æ√Ø]/g, 'i')
    .replace(/[√≤√≥√¥√µ√∂]/g, 'o')
    .replace(/[√π√∫√ª√º]/g, 'u')
    .replace(/[√ß]/g, 'c')
    .replace(/[^a-z0-9\s]/g, ' ')
    .trim();

  const keywords = normalizedQuery.split(' ').filter(word => word.length > 2);
  let bestMatch = null;
  let maxScore = 0;

  for (const [key, value] of Object.entries(faqLang)) {
    let score = 0;
    const normalizedKey = key.toLowerCase();
    const normalizedValue = value.toLowerCase();

    keywords.forEach(keyword => {
      if (normalizedKey.includes(keyword)) score += 3;
      if (normalizedValue.includes(keyword)) score += 1;
    });

    if (normalizedKey.includes(normalizedQuery)) score += 5;

    if (score > maxScore) {
      maxScore = score;
      bestMatch = { key, value, score };
    }
  }

  return maxScore > 2 ? bestMatch : null;
}

// Suggestions de questions
function getSuggestedQuestions(lang) {
  if (typeof quickQuestions === 'undefined') return "";
  
  const suggestions = quickQuestions[lang] || quickQuestions.fr;
  const randomSuggestions = suggestions.slice(0, 3);
  
  let suggestionText = "";
  switch(lang) {
    case 'en':
      suggestionText = "Here are some questions I can help with:\n‚Ä¢ " + randomSuggestions.join("\n‚Ä¢ ");
      break;
    case 'de':
      suggestionText = "Hier sind einige Fragen, bei denen ich helfen kann:\n‚Ä¢ " + randomSuggestions.join("\n‚Ä¢ ");
      break;
    default:
      suggestionText = "Voici quelques questions sur lesquelles je peux vous aider :\n‚Ä¢ " + randomSuggestions.join("\n‚Ä¢ ");
  }
  
  return suggestionText;
}

// Message de bienvenue
function showWelcomeMessage() {
  botMessages.innerHTML = "";
  addMessage("bot", responses[currentLang].welcome);
  loadFAQ();
}

// Gestion des messages utilisateur
function handleUserMessage(msg) {
  const normalizedMsg = msg.toLowerCase().trim();

  // Recherche dans la FAQ sp√©cialis√©e IA & Finance
  const faqResult = searchFAQ(normalizedMsg, currentLang);
  if (faqResult && faqResult.score > 2) {
    addMessage("bot", faqResult.value);
    return;
  }

  // R√©ponses basiques
  let reply = responses[currentLang].unknown;
  
  if (normalizedMsg.includes("bonjour") || normalizedMsg.includes("hello") || normalizedMsg.includes("hallo")) {
    reply = responses[currentLang].greeting;
  } else if (normalizedMsg.includes("service") || normalizedMsg.includes("solution")) {
    reply = responses[currentLang].services;
  } else if (normalizedMsg.includes("contact")) {
    reply = responses[currentLang].contact;
  } else if (normalizedMsg.includes("finance") || normalizedMsg.includes("epm") || normalizedMsg.includes("ia") || normalizedMsg.includes("ai") || normalizedMsg.includes("ki")) {
    reply = responses[currentLang].services;
  } else if (normalizedMsg.includes("bye") || normalizedMsg.includes("au revoir") || normalizedMsg.includes("tsch√ºss")) {
    reply = responses[currentLang].goodbye;
  }

  addMessage("bot", reply);

  // Suggestions si pas de r√©ponse trouv√©e
  if (reply === responses[currentLang].unknown) {
    setTimeout(() => {
      const suggestions = getSuggestedQuestions(currentLang);
      if (suggestions) {
        addMessage("bot", suggestions);
      }
    }, 1000);
  }
}

// Formulaire
botForm.addEventListener("submit", (e) => {
  e.preventDefault();
  const msg = botInput.value.trim();
  if (!msg) return;
  
  addMessage("user", msg);
  botInput.value = "";
  
  setTimeout(() => {
    handleUserMessage(msg);
  }, 500);
});

// Charger FAQ
function loadFAQ() {
  faqQuick.innerHTML = "";
  faqTitle.textContent = faqData[currentLang].title;

  // Questions g√©n√©rales
  faqData[currentLang].questions.forEach(q => {
    const btn = document.createElement("button");
    btn.className = "faq-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-200 transition mr-2 mb-2";
    btn.innerText = q;
    btn.addEventListener("click", () => {
      addMessage("user", q);
      setTimeout(() => handleUserMessage(q), 500);
    });
    faqQuick.appendChild(btn);
  });

  // Questions sp√©cialis√©es IA & Finance
  if (typeof quickQuestions !== 'undefined' && quickQuestions[currentLang]) {
    quickQuestions[currentLang].slice(0, 5).forEach(q => {
      const btn = document.createElement("button");
      btn.className = "faq-btn px-3 py-1 bg-green-100 text-green-700 rounded-lg text-sm hover:bg-green-200 transition mr-2 mb-2";
      btn.innerText = q;
      btn.addEventListener("click", () => {
        addMessage("user", q);
        setTimeout(() => handleUserMessage(q), 500);
      });
      faqQuick.appendChild(btn);
    });
  }
}

// Changement de langue
langSelect.addEventListener("change", () => {
  currentLang = langSelect.value;
  showWelcomeMessage();
});

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
  showWelcomeMessage();
});

if (document.readyState !== 'loading') {
  showWelcomeMessage();
}
</script>
